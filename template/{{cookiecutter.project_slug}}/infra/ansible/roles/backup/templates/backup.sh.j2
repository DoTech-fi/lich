#!/bin/bash
# {{ project_name }} - Database Backup Script
# Generated by Ansible

set -e

BACKUP_DIR="{{ project_home }}/backups/db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/{{ project_name }}_${TIMESTAMP}.sql.gz"
RETENTION_DAYS={{ backup_retention_days }}

echo "[$(date)] Starting backup..."

# PostgreSQL backup
docker exec {{ project_name }}_postgres pg_dump -U {{ db_user }} {{ db_name }} | gzip > "${BACKUP_FILE}"

echo "[$(date)] Backup saved to ${BACKUP_FILE}"

# Clean old backups
find "${BACKUP_DIR}" -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete
echo "[$(date)] Cleaned backups older than ${RETENTION_DAYS} days"

{% if backup_s3_bucket | length > 0 %}
# Upload to S3
aws s3 cp "${BACKUP_FILE}" "s3://{{ backup_s3_bucket }}/{{ project_name }}/"
echo "[$(date)] Uploaded to S3"
{% endif %}

echo "[$(date)] Backup completed successfully"
