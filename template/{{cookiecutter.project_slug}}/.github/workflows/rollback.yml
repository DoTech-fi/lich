name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      backup_file:
        description: 'Backup file to restore (from S3 or local path)'
        required: true
        type: string
      rollback_code:
        description: 'Also rollback code to previous tag'
        required: false
        type: boolean
        default: true
      previous_tag:
        description: 'Previous tag to rollback to (if rollback_code is true)'
        required: false
        type: string

permissions:
  contents: read

env:
  SSH_USER: ${{ "{{" }} secrets.SSH_USER {{ "}}" }}
  SSH_HOST: ${{ "{{" }} secrets[format('{0}_SSH_HOST', inputs.environment)] {{ "}}" }}

jobs:
  confirm:
    runs-on: ubuntu-latest
    steps:
      - name: Confirmation
        run: |
          echo "⚠️ ROLLBACK CONFIRMATION"
          echo "========================"
          echo "Environment: ${{ "{{" }} inputs.environment {{ "}}" }}"
          echo "Backup file: ${{ "{{" }} inputs.backup_file {{ "}}" }}"
          echo "Rollback code: ${{ "{{" }} inputs.rollback_code {{ "}}" }}"
          echo "Previous tag: ${{ "{{" }} inputs.previous_tag {{ "}}" }}"
          echo ""
          echo "This action will:"
          echo "1. Stop the application"
          echo "2. Restore database from backup"
          echo "3. Optionally rollback code"
          echo "4. Restart the application"

  rollback:
    runs-on: ubuntu-latest
    needs: [confirm]
    steps:
      - name: Stop application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            cd /opt/{{ cookiecutter.project_slug }}/app
            docker compose stop backend
            echo "Application stopped"

      - name: Download backup from S3
        if: startsWith(inputs.backup_file, 's3://')
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            export AWS_ACCESS_KEY_ID=${{ "{{" }} secrets.AWS_ACCESS_KEY_ID {{ "}}" }}
            export AWS_SECRET_ACCESS_KEY=${{ "{{" }} secrets.AWS_SECRET_ACCESS_KEY {{ "}}" }}
            aws s3 cp ${{ "{{" }} inputs.backup_file {{ "}}" }} /tmp/restore.sql.gz
            echo "Backup downloaded from S3"

      - name: Restore database
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            cd /opt/{{ cookiecutter.project_slug }}
            
            # Use S3 backup or local path
            if [[ "${{ "{{" }} inputs.backup_file {{ "}}" }}" == s3://* ]]; then
              backup_path="/tmp/restore.sql.gz"
            else
              backup_path="${{ "{{" }} inputs.backup_file {{ "}}" }}"
            fi
            
            # Restore database
            gunzip -c "$backup_path" | docker exec -i {{ cookiecutter.project_slug }}_postgres psql -U postgres {{ cookiecutter.project_slug }}
            
            echo "Database restored from $backup_path"

      - name: Rollback code
        if: ${{ "{{" }} inputs.rollback_code && inputs.previous_tag != '' {{ "}}" }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            cd /opt/{{ cookiecutter.project_slug }}/app
            git fetch --tags
            git checkout ${{ "{{" }} inputs.previous_tag {{ "}}" }}
            docker compose build
            echo "Code rolled back to ${{ "{{" }} inputs.previous_tag {{ "}}" }}"

      - name: Start application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            cd /opt/{{ cookiecutter.project_slug }}/app
            docker compose up -d backend
            echo "Application started"

      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Waiting for service... ($i/30)"
              sleep 2
            done
            echo "Health check failed!"
            exit 1

      - name: Cleanup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ "{{" }} env.SSH_HOST {{ "}}" }}
          username: ${{ "{{" }} env.SSH_USER {{ "}}" }}
          key: ${{ "{{" }} secrets.SSH_PRIVATE_KEY {{ "}}" }}
          script: |
            rm -f /tmp/restore.sql.gz
            echo "Cleanup complete"

  notify:
    runs-on: ubuntu-latest
    needs: [rollback]
    if: always()
    steps:
      - name: Notify result
        run: |
          if [ "${{ "{{" }} needs.rollback.result {{ "}}" }}" == "success" ]; then
            echo "✅ Rollback to ${{ "{{" }} inputs.environment {{ "}}" }} succeeded!"
          else
            echo "❌ Rollback to ${{ "{{" }} inputs.environment {{ "}}" }} failed!"
          fi
