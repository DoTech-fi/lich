# Backup role - Automated backups with cron
---
- name: Create backup directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ project_user }}"
    group: "{{ project_group }}"
    mode: '0755'
  loop:
    - "{{ project_home }}/backups"
    - "{{ project_home }}/backups/db"

- name: Install backup script
  template:
    src: backup.sh.j2
    dest: "{{ project_home }}/backups/backup.sh"
    owner: "{{ project_user }}"
    group: "{{ project_group }}"
    mode: '0755'

- name: Setup backup cron job
  cron:
    name: "{{ project_name }} database backup"
    job: "{{ project_home }}/backups/backup.sh >> {{ project_home }}/backups/backup.log 2>&1"
    minute: "{{ backup_schedule.split()[0] }}"
    hour: "{{ backup_schedule.split()[1] }}"
    day: "{{ backup_schedule.split()[2] }}"
    month: "{{ backup_schedule.split()[3] }}"
    weekday: "{{ backup_schedule.split()[4] }}"
    user: "{{ project_user }}"
  when: backup_enabled

- name: Install AWS CLI for S3 backups
  apt:
    name: awscli
    state: present
  when: backup_s3_bucket | length > 0
